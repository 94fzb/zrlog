/* liteUploader v2.2.0 | https://github.com/burt202/lite-uploader | Aaron Burtnyk (http://www.burtdev.net) */

function LiteUploader(t,e){this.el=$(t),this.options=e,this.params=e.params,this.xhr=this._buildXhrObject(),this._init()}$.fn.liteUploader=function(t){var e={script:null,rules:{allowedFileTypes:null,maxSize:null},params:{},changeHandler:!0,clickElement:null};return this.each(function(){$.data(this,"liteUploader",new LiteUploader(this,$.extend(e,t)))})},LiteUploader.prototype={_init:function(){this.options.changeHandler&&this.el.change(function(){this._start()}.bind(this)),this.options.clickElement&&this.options.clickElement.click(function(){this._start()}.bind(this))},_start:function(){var t=this.el.get(0).files,e=this._getInputErrors(t);e||(e=this._getFileErrors(t)),e?(this.el.trigger("lu:errors",e),this._resetInput()):(this.el.trigger("lu:before",[t]),this._performUpload(this._collateFormData(t)))},_resetInput:function(){this.el.val("")},_getInputErrors:function(t){var e=[],i=[];return this.el.attr("name")||e.push({type:"fileInputNameRequired"}),this.options.script||e.push({type:"scriptOptionRequired"}),0===t.length&&e.push({type:"noFilesSelected"}),i.push({name:"liteUploader_input",errors:e}),e.length>0?[i]:null},_getFileErrors:function(t){var e=0,i=[];return $.each(t,function(n){var r=this._findErrorsForFile(t[n]);i.push({name:t[n].name,errors:r}),e+=r.length}.bind(this)),e>0?[i]:null},_findErrorsForFile:function(t){var e=[];return $.each(this.options.rules,function(i,n){"allowedFileTypes"===i&&n&&-1===$.inArray(t.type,n.split(","))&&e.push({type:"type",rule:n,given:t.type}),"maxSize"===i&&n&&t.size>n&&e.push({type:"size",rule:n,given:t.size})}),e},_getFormDataObject:function(){return new FormData},_collateFormData:function(t){var e=this._getFormDataObject();return this.el.attr("id")&&e.append("liteUploader_id",this.el.attr("id")),$.each(this.params,function(t,i){e.append(t,i)}),$.each(t,function(i){e.append(this.el.attr("name"),t[i])}.bind(this)),e},_buildXhrObject:function(){var t=new XMLHttpRequest;return t.upload.addEventListener("progress",this._onXHRProgress.bind(this),!1),t},_getXHRObject:function(){return this.xhr},_performUpload:function(t){$.ajax({xhr:this._getXHRObject.bind(this),url:this.options.script,type:"POST",data:t,processData:!1,contentType:!1}).done(this._onXHRSuccess.bind(this)).fail(this._onXHRFailure.bind(this)).always(this._onXHRAlways.bind(this))},_onXHRProgress:function(t){t.lengthComputable&&this.el.trigger("lu:progress",Math.floor(t.loaded/t.total*100))},_onXHRSuccess:function(t){this.el.trigger("lu:success",t)},_onXHRFailure:function(t){this.el.trigger("lu:fail",t)},_onXHRAlways:function(){this._resetInput()},addParam:function(t,e){this.params[t]=e},cancelUpload:function(){this.xhr.abort(),this.el.trigger("lu:cancelled"),this._resetInput()}};
